<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Diritto dell'Informatica - Modalità Multiple</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        :root {
            --primary-color: #007bff;
            --primary-hover-color: #0056b3;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-bg-color: #f8f9fa;
            --dark-text-color: #343a40;
            --light-text-color: #f8f9fa;
            --border-color: #dee2e6;
            --card-bg-color: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.7;
            margin: 0;
            padding: 20px;
            background-color: var(--light-bg-color);
            color: var(--dark-text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background-color: var(--card-bg-color);
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 850px;
            text-align: center;
            margin-top: 20px;
        }
        h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-weight: 600;
            font-size: 2.2em;
        }
        h2 {
            color: var(--primary-hover-color);
            margin-top: 25px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        #file-input-container, #mode-selection-area, #topic-selection-area-practice, #quiz-area, #results-area {
            margin-top: 25px;
        }

        /* File Input */
        #file-input-container label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 1.1em;
        }
        input[type="file"] {
            display: block;
            margin: 0 auto 20px auto;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #f1f3f5;
        }

        /* Mode Selection */
        #mode-selection-area button {
            padding: 15px 30px;
            font-size: 1.1em;
            margin: 10px;
            min-width: 220px;
        }

        /* Topic Selection for Practice */
        #topic-selection-area-practice label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--secondary-color);
        }
        #topic-select-practice {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-right: 10px;
            min-width: 250px;
            font-size: 1em;
        }


        /* Quiz Area */
        #question-topic {
            font-size: 0.95em;
            color: var(--secondary-color);
            margin-bottom: 8px;
            font-weight: 400;
        }
        #question-text {
            font-size: 1.35em;
            margin-bottom: 30px;
            min-height: 70px;
            color: var(--dark-text-color);
            font-weight: 400;
        }
        .options button {
            display: block;
            width: 100%;
            padding: 14px 18px;
            margin: 12px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg-color);
            color: var(--dark-text-color);
            cursor: pointer;
            font-size: 1.05em;
            text-align: left;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease, box-shadow 0.2s;
        }
        .options button:hover:not(:disabled) {
            background-color: #eef2f7;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }
        .options button.correct {
            background-color: #d1e7dd;
            color: #0f5132;
            border-color: #badbcc;
            font-weight: 600;
        }
        .options button.incorrect {
            background-color: #f8d7da;
            color: #842029;
            border-color: #f5c2c7;
        }
        .options button.selected:not(.correct):not(.incorrect) {
             background-color: #cfe2ff;
             border-color: #b6d4fe;
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.65;
        }

        /* Control Buttons */
        .control-buttons button, #start-practice-topic-quiz-btn, .mode-btn {
            padding: 12px 28px;
            background-color: var(--primary-color);
            color: var(--light-text-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.05em;
            margin: 10px 8px;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
            font-weight: 600;
        }
        .control-buttons button:hover:not(:disabled), #start-practice-topic-quiz-btn:hover:not(:disabled), .mode-btn:hover:not(:disabled) {
            background-color: var(--primary-hover-color);
            transform: translateY(-1px);
        }
        #prev-btn {
            background-color: var(--secondary-color);
        }
        #prev-btn:hover:not(:disabled) {
            background-color: #545b62;
        }

        #feedback {
            margin-top: 22px;
            font-weight: 600;
            min-height: 30px;
            font-size: 1.15em;
        }
        #score-display {
            font-size: 1.25em;
            margin-bottom: 18px;
            font-weight: 600;
        }
        #incorrect-questions-list {
            list-style-type: none;
            padding: 0;
            text-align: left;
            margin-top: 22px;
        }
        #incorrect-questions-list li {
            background-color: #fff3cd;
            padding: 12px;
            border: 1px solid #ffeeba;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.98em;
        }
        #incorrect-questions-list li strong {
            color: var(--primary-hover-color);
        }

        #progress-bar-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 25px;
            margin-bottom: 30px;
            height: 28px;
            overflow: hidden;
        }
        #progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--success-color) 0%, #4aa051 100%);
            border-radius: 25px;
            text-align: center;
            line-height: 28px;
            color: white;
            font-weight: 600;
            transition: width 0.4s ease-in-out;
            font-size: 0.95em;
        }

        .btn-secondary { /* Stile per pulsante "Indietro" o alternativo */
            background-color: var(--secondary-color) !important;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #545b62 !important;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Quiz Diritto dell'Informatica</h1>

        <div id="file-input-container">
            <label for="json-file">Carica il file JSON delle domande:</label>
            <input type="file" id="json-file" accept=".json">
            <p id="file-feedback" style="min-height: 20px; margin-top: 10px; color: var(--secondary-color);"></p>
        </div>

        <div id="mode-selection-area" style="display: none;">
            <h2>Scegli la Modalità del Quiz</h2>
            <button id="exam-mode-btn" class="mode-btn">Modalità Esame (30 Domande Casuali)</button>
            <button id="practice-mode-btn" class="mode-btn">Modalità Pratica per Argomento</button>
        </div>

        <div id="topic-selection-area-practice" style="display: none;">
            <h2>Seleziona un Argomento per la Pratica</h2>
            <select id="topic-select-practice">
                <!-- Opzioni argomento caricate da JS -->
            </select>
            <button id="start-practice-topic-quiz-btn">Inizia Pratica</button>
            <button id="back-to-mode-select-btn" class="btn-secondary">Indietro</button>
        </div>

        <div id="quiz-area" style="display: none;">
            <div id="progress-bar-container">
                <div id="progress-bar">0%</div>
            </div>
            <p id="question-topic"></p>
            <p id="question-text"></p>
            <div class="options" id="options-container"></div>
            <p id="feedback"></p>
            <div class="control-buttons">
                <button id="prev-btn" style="display: none;">Precedente</button>
                <button id="next-btn" style="display: none;">Successiva / Fine</button>
            </div>
             <button id="quit-quiz-btn" class="btn-secondary" style="margin-top: 20px;">Esci dal Quiz</button>
        </div>

        <div id="results-area" style="display: none;">
            <h2 id="results-title">Risultati del Quiz</h2>
            <p id="score-display"></p>
            <h3>Domande Sbagliate:</h3>
            <ul id="incorrect-questions-list"></ul>
            <button id="restart-btn" class="control-buttons">Nuovo Quiz</button>
        </div>
    </div>

    <script>
        // ... (gran parte del JS precedente rimarrà simile, con aggiunte per la nuova logica) ...
        const questionTextElement = document.getElementById('question-text');
        const questionTopicElement = document.getElementById('question-topic');
        const optionsContainer = document.getElementById('options-container');
        const feedbackElement = document.getElementById('feedback');
        const fileFeedbackElement = document.getElementById('file-feedback');
        const nextButton = document.getElementById('next-btn');
        const prevButton = document.getElementById('prev-btn');
        const quitQuizButton = document.getElementById('quit-quiz-btn');
        
        const quizArea = document.getElementById('quiz-area');
        const resultsArea = document.getElementById('results-area');
        const resultsTitle = document.getElementById('results-title');
        const scoreDisplay = document.getElementById('score-display');
        const incorrectQuestionsList = document.getElementById('incorrect-questions-list');
        
        const jsonFileInput = document.getElementById('json-file');
        const fileInputContainer = document.getElementById('file-input-container');
        
        const modeSelectionArea = document.getElementById('mode-selection-area');
        const examModeButton = document.getElementById('exam-mode-btn');
        const practiceModeButton = document.getElementById('practice-mode-btn');

        const topicSelectionAreaPractice = document.getElementById('topic-selection-area-practice');
        const topicSelectPractice = document.getElementById('topic-select-practice');
        const startPracticeTopicQuizButton = document.getElementById('start-practice-topic-quiz-btn');
        const backToModeSelectButton = document.getElementById('back-to-mode-select-btn');
        const restartButton = document.getElementById('restart-btn');

        const progressBar = document.getElementById('progress-bar');

        let allQuestions = [];
        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = {};
        const EXAM_MODE_QUESTION_COUNT = 30;

        jsonFileInput.addEventListener('change', handleFileLoad);
        examModeButton.addEventListener('click', startExamMode);
        practiceModeButton.addEventListener('click', showPracticeTopicSelection);
        startPracticeTopicQuizButton.addEventListener('click', startPracticeMode);
        backToModeSelectButton.addEventListener('click', () => {
            topicSelectionAreaPractice.style.display = 'none';
            modeSelectionArea.style.display = 'block';
        });

        nextButton.addEventListener('click', navigateNext);
        prevButton.addEventListener('click', navigatePrev);
        quitQuizButton.addEventListener('click', () => {
            // Chiedi conferma prima di uscire
            if (confirm("Sei sicuro di voler uscire dal quiz? I progressi non salvati andranno persi.")) {
                resetAndShowModeSelection();
            }
        });

        restartButton.addEventListener('click', resetAndGoToStart);


        function resetAndGoToStart() {
            quizArea.style.display = 'none';
            resultsArea.style.display = 'none';
            modeSelectionArea.style.display = 'none';
            topicSelectionAreaPractice.style.display = 'none';
            fileInputContainer.style.display = 'block';
            jsonFileInput.value = '';
            fileFeedbackElement.textContent = '';
            allQuestions = [];
            currentQuizQuestions = [];
            userAnswers = {};
            currentQuestionIndex = 0;
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
        }
        
        function resetAndShowModeSelection() {
            quizArea.style.display = 'none';
            resultsArea.style.display = 'none';
            topicSelectionAreaPractice.style.display = 'none';
            modeSelectionArea.style.display = 'block'; // Mostra la selezione della modalità
            currentQuizQuestions = [];
            userAnswers = {};
            currentQuestionIndex = 0;
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
        }


        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        allQuestions = JSON.parse(e.target.result);
                        if (Array.isArray(allQuestions) && allQuestions.length > 0) {
                            modeSelectionArea.style.display = 'block';
                            fileInputContainer.style.display = 'none';
                            fileFeedbackElement.textContent = `Caricate ${allQuestions.length} domande. Scegli una modalità.`;
                            populatePracticeTopicSelector(); // Popola il selettore anche se non subito visibile
                        } else {
                            fileFeedbackElement.textContent = 'File JSON non valido o vuoto.';
                        }
                    } catch (error) {
                        fileFeedbackElement.textContent = 'Errore nel parsing del file JSON.';
                        console.error("Errore JSON:", error);
                    }
                };
                reader.readAsText(file);
            }
        }

        function populatePracticeTopicSelector() {
            const topics = [...new Set(allQuestions.map(q => q.topic))].sort();
            topicSelectPractice.innerHTML = ''; // Reset
            topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic;
                topicSelectPractice.appendChild(option);
            });
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function getExamQuestions() {
            if (allQuestions.length === 0) return [];
            
            let availableQuestions = [...allQuestions];
            shuffleArray(availableQuestions); // Mescola tutte le domande disponibili

            if (availableQuestions.length <= EXAM_MODE_QUESTION_COUNT) {
                return availableQuestions; // Se ci sono meno o uguali a 30 domande, prendile tutte
            }
            
            // Strategia per cercare di bilanciare gli argomenti
            const questionsByTopic = {};
            allQuestions.forEach(q => {
                if (!questionsByTopic[q.topic]) {
                    questionsByTopic[q.topic] = [];
                }
                questionsByTopic[q.topic].push(q);
            });

            const topics = Object.keys(questionsByTopic);
            let examQuestions = [];
            let questionsPerTopic = Math.floor(EXAM_MODE_QUESTION_COUNT / topics.length);
            let remainingQuestions = EXAM_MODE_QUESTION_COUNT % topics.length;

            topics.forEach(topic => {
                shuffleArray(questionsByTopic[topic]);
                let countForThisTopic = questionsPerTopic + (remainingQuestions > 0 ? 1 : 0);
                examQuestions.push(...questionsByTopic[topic].slice(0, countForThisTopic));
                if (remainingQuestions > 0) remainingQuestions--;
            });
            
            // Se non abbiamo raggiunto EXAM_MODE_QUESTION_COUNT (es. un argomento aveva poche domande)
            // riempi con altre domande casuali, evitando duplicati.
            if (examQuestions.length < EXAM_MODE_QUESTION_COUNT) {
                const existingIds = new Set(examQuestions.map(q => q.question)); // Usa 'question' come ID se univoco
                let additionalNeeded = EXAM_MODE_QUESTION_COUNT - examQuestions.length;
                
                let safetyCounter = 0; // Per evitare loop infiniti
                while(additionalNeeded > 0 && safetyCounter < allQuestions.length * 2) {
                    const randomQ = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
                    if (!existingIds.has(randomQ.question)) {
                        examQuestions.push(randomQ);
                        existingIds.add(randomQ.question);
                        additionalNeeded--;
                    }
                    safetyCounter++;
                }
            }
             // Assicurati di non superare EXAM_MODE_QUESTION_COUNT e mescola il risultato finale
            shuffleArray(examQuestions);
            return examQuestions.slice(0, EXAM_MODE_QUESTION_COUNT);
        }


        function startExamMode() {
            currentQuizQuestions = getExamQuestions();
            if (currentQuizQuestions.length === 0) {
                fileFeedbackElement.textContent = 'Non ci sono abbastanza domande per la modalità esame o file non caricato.';
                return;
            }
            commonQuizStartSetup("Modalità Esame");
        }

        function showPracticeTopicSelection() {
            modeSelectionArea.style.display = 'none';
            topicSelectionAreaPractice.style.display = 'block';
        }

        function startPracticeMode() {
            const selectedTopic = topicSelectPractice.value;
            currentQuizQuestions = allQuestions.filter(q => q.topic === selectedTopic);
            if (currentQuizQuestions.length === 0) {
                alert('Nessuna domanda trovata per questo argomento.');
                return;
            }
            // Potresti mescolare: shuffleArray(currentQuizQuestions);
            commonQuizStartSetup(`Pratica: ${selectedTopic}`);
        }

        function commonQuizStartSetup(quizTitle) {
            currentQuestionIndex = 0;
            userAnswers = {};
            modeSelectionArea.style.display = 'none';
            topicSelectionAreaPractice.style.display = 'none';
            quizArea.style.display = 'block';
            resultsArea.style.display = 'none';
            feedbackElement.textContent = ''; // Pulisci feedback precedenti
            resultsTitle.textContent = quizTitle; // Imposta il titolo per quando si mostreranno i risultati
            loadQuestion();
            updateNavigationButtons();
            updateProgressBar();
        }
        
        function loadQuestion() {
            // ... (invariato rispetto alla versione precedente, ma assicurati che questionTopicElement sia aggiornato)
            const questionData = currentQuizQuestions[currentQuestionIndex];
            questionTopicElement.textContent = `Argomento: ${questionData.topic} (Domanda ${currentQuestionIndex + 1} di ${currentQuizQuestions.length})`;
            questionTextElement.textContent = questionData.question;
            optionsContainer.innerHTML = '';
            feedbackElement.textContent = ''; // Pulisci feedback precedente

            const hasAnsweredThis = userAnswers.hasOwnProperty(currentQuestionIndex);

            questionData.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                
                if (hasAnsweredThis) {
                    button.disabled = true;
                    if (index === questionData.answer) {
                        button.classList.add('correct');
                    } else if (index === userAnswers[currentQuestionIndex]) {
                        button.classList.add('incorrect');
                    }
                     if (index === userAnswers[currentQuestionIndex]) {
                         button.classList.add('selected');
                    }
                } else {
                    button.addEventListener('click', () => selectAnswer(index));
                }
                optionsContainer.appendChild(button);
            });
            updateNavigationButtons();
        }

        function selectAnswer(selectedIndex) {
            // ... (invariato)
             if (userAnswers.hasOwnProperty(currentQuestionIndex)) return; 

            userAnswers[currentQuestionIndex] = selectedIndex;
            
            const questionData = currentQuizQuestions[currentQuestionIndex];
            const buttons = optionsContainer.getElementsByTagName('button');
            let isCorrect = selectedIndex === questionData.answer;

            if (isCorrect) {
                feedbackElement.textContent = 'Corretto!';
                feedbackElement.style.color = 'var(--success-color)';
            } else {
                feedbackElement.textContent = `Sbagliato! La risposta corretta era: ${questionData.options[questionData.answer]}`;
                feedbackElement.style.color = 'var(--danger-color)';
                buttons[selectedIndex].classList.add('incorrect');
            }
            buttons[questionData.answer].classList.add('correct');

            for (let button of buttons) {
                button.disabled = true;
            }
            updateNavigationButtons();
            updateProgressBar();
        }

        function navigateNext() {
            // ... (invariato)
             if (currentQuestionIndex < currentQuizQuestions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                showResults();
            }
        }

        function navigatePrev() {
            // ... (invariato)
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        function updateNavigationButtons() {
            // ... (leggermente modificato per gestire meglio il next all'ultima domanda)
            prevButton.style.display = currentQuestionIndex > 0 ? 'inline-block' : 'none';
            
            const isLastQuestion = currentQuestionIndex === currentQuizQuestions.length - 1;
            const answeredCurrent = userAnswers.hasOwnProperty(currentQuestionIndex);

            if (isLastQuestion) {
                nextButton.textContent = answeredCurrent ? 'Mostra Risultati' : 'Successiva';
                nextButton.style.display = answeredCurrent ? 'inline-block' : 'none';
            } else {
                nextButton.textContent = 'Successiva';
                nextButton.style.display = 'inline-block';
            }
        }
        
        function updateProgressBar() {
            // ... (invariato)
            const answeredCount = Object.keys(userAnswers).length;
            const progress = currentQuizQuestions.length > 0 ? (answeredCount / currentQuizQuestions.length) * 100 : 0;
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${Math.round(progress)}% (${answeredCount}/${currentQuizQuestions.length})`;
        }

        function showResults() {
            // ... (invariato, ma assicurati che resultsTitle sia già impostato)
            quizArea.style.display = 'none';
            resultsArea.style.display = 'block';
            
            let score = 0;
            const incorrectAnswersDetails = [];

            for (let i = 0; i < currentQuizQuestions.length; i++) {
                const questionData = currentQuizQuestions[i];
                 if (!userAnswers.hasOwnProperty(i) && currentQuizQuestions.length > 0) { // Se una domanda non è stata risposta
                    incorrectAnswersDetails.push({
                        question: questionData.question,
                        topic: questionData.topic,
                        yourAnswer: "<i>Non risposto</i>",
                        correctAnswer: questionData.options[questionData.answer]
                    });
                    continue; // Passa alla prossima domanda
                }
                if (userAnswers[i] === questionData.answer) {
                    score++;
                } else {
                    incorrectAnswersDetails.push({
                        question: questionData.question,
                        topic: questionData.topic,
                        yourAnswer: questionData.options[userAnswers[i]],
                        correctAnswer: questionData.options[questionData.answer]
                    });
                }
            }
            
            scoreDisplay.textContent = `Punteggio Finale: ${score} su ${currentQuizQuestions.length}`;
            
            incorrectQuestionsList.innerHTML = '';
            if (incorrectAnswersDetails.length > 0) {
                incorrectAnswersDetails.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Domanda (${item.topic}):</strong> ${item.question}<br>
                                    <em>Tua risposta:</em> ${item.yourAnswer}<br>
                                    <em>Risposta corretta:</em> ${item.correctAnswer}`;
                    incorrectQuestionsList.appendChild(li);
                });
            } else {
                if (currentQuizQuestions.length > 0) {
                    incorrectQuestionsList.innerHTML = '<li>Nessuna domanda sbagliata! Complimenti!</li>';
                } else {
                     incorrectQuestionsList.innerHTML = '<li>Nessuna domanda presente in questo quiz.</li>';
                }
            }
        }

    </script>
</body>
</html>